<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Sistema di tracciamento interventi meccanici con tecnologia NFC">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TANO Garage">
    
    <title>Garage NFC - Tracciamento Interventi</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* ---------- Fond d'√©cran principal ---------- */
        html, body {
            height: 100%;
            margin: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: url('Background.png') no-repeat center center fixed;
            background-size: cover;
            background-position: center top;
            color: white;
            min-height: 100vh;
            opacity: 0;
            animation: fadeIn 1s ease-in-out forwards;
        }
        body::before {
            content: "";
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.55);
            backdrop-filter: blur(2px);
            z-index: -1;
        }

        #app {
            background: rgba(0,0,0,0.35);
            min-height: 100vh;
            padding-bottom: 50px;
        }

        /* ---------- Effet verre d√©poli ---------- */
        .bg-white {
            background-color: rgba(255,255,255,0.14) !important;
            -webkit-backdrop-filter: blur(10px) saturate(120%);
            backdrop-filter: blur(10px) saturate(120%);
            border: 1px solid rgba(255,255,255,0.22);
            box-shadow: 0 8px 24px rgba(0,0,0,0.25);
            transition: all 0.4s ease;
        }
        .bg-blue-600 {
            background-color: rgba(37,99,235,0.80) !important;
            -webkit-backdrop-filter: blur(8px) saturate(120%);
            backdrop-filter: blur(8px) saturate(120%);
            border-bottom: 1px solid rgba(255,255,255,0.18);
        }
        .bg-green-600, .bg-green-700, .bg-red-600 {
            filter: saturate(115%);
            box-shadow: 0 6px 16px rgba(0,0,0,0.25);
        }

        /* ---------- Inputs lisibles ---------- */
        input, textarea, select {
            color: #111 !important;
            background-color: #fff !important;
            border: 1px solid #d1d5db !important;
        }
        input::placeholder, textarea::placeholder {
            color: #666 !important;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59,130,246,0.35);
            border-color: #3b82f6 !important;
        }

        /* ---------- Mobile / tablette ---------- */
        @media (max-width: 768px) {
            body {
                background: url('Background.png') no-repeat center center fixed;
                background-size: contain;
                background-color: #000;
            }
            #app {
                background: rgba(0,0,0,0.6);
            }
            .bg-white {
                background-color: rgba(255,255,255,0.18) !important;
                -webkit-backdrop-filter: blur(12px) saturate(120%);
                backdrop-filter: blur(12px) saturate(120%);
            }
        }

        /* ---------- Animation fade-in ---------- */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>

<body class="bg-gray-100">
    <div id="app">Caricamento...</div>

    <script>
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        let vehicles = {};
        let currentVehicle = null;
        let showAddForm = false;

        function loadData() {
            try {
                const stored = localStorage.getItem('garage_vehicles');
                if (stored) {
                    vehicles = JSON.parse(stored);
                }
            } catch (error) {
                console.log('Primo utilizzo');
                vehicles = {};
            }

            const targaFromUrl = getUrlParameter('targa');
            if (targaFromUrl) {
                const targaUpper = targaFromUrl.toUpperCase();
                
                if (vehicles[targaUpper]) {
                    currentVehicle = targaUpper;
                } else {
                    if (confirm(`Il veicolo ${targaUpper} non esiste ancora.\n\nVuoi crearlo ora?`)) {
                        setTimeout(() => {
                            const input = document.getElementById('newVehicleTarga');
                            if (input) {
                                input.value = targaUpper;
                                input.focus();
                            }
                        }, 100);
                    }
                }
            }

            render();
        }

        function saveData() {
            try {
                localStorage.setItem('garage_vehicles', JSON.stringify(vehicles));
            } catch (error) {
                console.error('Errore di salvataggio:', error);
                alert('Errore durante il salvataggio');
            }
        }

        function addVehicle() {
            const targa = document.getElementById('newVehicleTarga').value.toUpperCase().trim();
            const marca = document.getElementById('newVehicleMarca').value.trim();
            const modello = document.getElementById('newVehicleModello').value.trim();
            const anno = document.getElementById('newVehicleAnno').value.trim();
            const km = document.getElementById('newVehicleKm').value.trim();

            if (!targa) {
                alert('Targa obbligatoria');
                return;
            }

            vehicles[targa] = {
                targa: targa,
                marca: marca,
                modello: modello,
                anno: anno,
                chilometraggio: km,
                interventi: []
            };

            saveData();
            currentVehicle = targa;
            render();
        }

        function addIntervento() {
            const data = document.getElementById('interventoData').value;
            const tipo = document.getElementById('interventoTipo').value;
            const descrizione = document.getElementById('interventoDesc').value;
            const ricambi = document.getElementById('interventoRicambi').value;
            const costo = document.getElementById('interventoCosto').value;
            const km = document.getElementById('interventoKm').value;
            const meccanico = document.getElementById('interventoMeccanico').value;
            const note = document.getElementById('interventoNote').value;

            if (!tipo || !descrizione) {
                alert('Tipo e descrizione obbligatori');
                return;
            }

            const intervento = {
                id: Date.now(),
                data: data,
                tipo: tipo,
                descrizione: descrizione,
                ricambi: ricambi,
                costo: costo,
                chilometraggio: km,
                meccanico: meccanico,
                note: note,
                dataRegistrazione: new Date().toISOString()
            };

            vehicles[currentVehicle].interventi.unshift(intervento);
            
            if (km) {
                vehicles[currentVehicle].chilometraggio = km;
            }

            saveData();
            showAddForm = false;
            render();
        }

        function deleteIntervento(id) {
            if (!confirm('Eliminare questo intervento?')) return;
            
            vehicles[currentVehicle].interventi = 
                vehicles[currentVehicle].interventi.filter(i => i.id !== id);
            
            saveData();
            render();
        }

        function deleteVehicle(targa) {
            if (!confirm(`Eliminare definitivamente il veicolo ${targa} e tutto lo storico?`)) return;
            
            delete vehicles[targa];
            saveData();
            render();
        }

        function exportToExcel() {
            const vehicle = vehicles[currentVehicle];
            
            let testo = "Data;Tipo;Descrizione;Ricambi;Costo;Chilometraggio;Meccanico;Note\n";
            
            vehicle.interventi.forEach(inter => {
                testo += `${inter.data || ''};`;
                testo += `${inter.tipo || ''};`;
                testo += `${(inter.descrizione || '').replace(/;/g, ',')};`;
                testo += `${(inter.ricambi || '').replace(/;/g, ',')};`;
                testo += `${inter.costo || ''};`;
                testo += `${inter.chilometraggio || ''};`;
                testo += `${inter.meccanico || ''};`;
                testo += `${(inter.note || '').replace(/;/g, ',')}\n`;
            });

            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(testo));
            element.setAttribute('download', vehicle.targa + '.csv');
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }

        function exportToPDF() {
            const vehicle = vehicles[currentVehicle];
            
            let testo = `STORICO - ${vehicle.targa}\n`;
            testo += `${vehicle.marca} ${vehicle.modello} ${vehicle.anno || ''}\n`;
            if (vehicle.chilometraggio) testo += `Chilometraggio: ${vehicle.chilometraggio} km\n`;
            testo += `\n${'='.repeat(50)}\n\n`;
            
            vehicle.interventi.forEach((inter, i) => {
                testo += `${i + 1}. ${inter.data || 'Nessuna data'} - ${inter.tipo}\n`;
                testo += `   ${inter.descrizione}\n`;
                if (inter.ricambi) testo += `   Ricambi: ${inter.ricambi}\n`;
                if (inter.costo) testo += `   Costo: ${inter.costo} euro\n`;
                if (inter.chilometraggio) testo += `   Km: ${inter.chilometraggio}\n`;
                if (inter.meccanico) testo += `   Meccanico: ${inter.meccanico}\n`;
                if (inter.note) testo += `   Note: ${inter.note}\n`;
                testo += '\n';
            });
            
            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(testo));
            element.setAttribute('download', vehicle.targa + '.txt');
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }

        function filterVehicles() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const vehiclesList = Object.values(vehicles).filter(v =>
                v.targa.toLowerCase().includes(search) ||
                v.marca.toLowerCase().includes(search) ||
                v.modello.toLowerCase().includes(search)
            );
            
            renderVehiclesList(vehiclesList);
        }

        function renderVehiclesList(filteredVehicles) {
            const container = document.getElementById('vehiclesList');
            
            if (filteredVehicles.length === 0) {
                container.innerHTML = `
                    <div class="bg-white rounded-lg shadow p-8 text-center text-gray-500">
                        <svg class="mx-auto mb-3 opacity-50" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M5 17h14v-5.5L16.5 7H7.5L5 11.5V17z M5 17v1a1 1 0 001 1h1a1 1 0 001-1v-1M5 17h14m0 0v1a1 1 0 001 1h1a1 1 0 001-1v-1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <circle cx="8" cy="17" r="2" stroke-width="2"/>
                            <circle cx="16" cy="17" r="2" stroke-width="2"/>
                        </svg>
                        <p>Nessun veicolo trovato</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredVehicles.map(v => `
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex-1 cursor-pointer" onclick="currentVehicle='${v.targa}'; render();">
                            <div class="flex items-center gap-2">
                                <svg width="24" height="24" class="text-blue-600" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path d="M5 17h14v-5.5L16.5 7H7.5L5 11.5V17z M5 17v1a1 1 0 001 1h1a1 1 0 001-1v-1M5 17h14m0 0v1a1 1 0 001 1h1a1 1 0 001-1v-1" stroke-width="2"/>
                                    <circle cx="8" cy="17" r="2" stroke-width="2"/>
                                    <circle cx="16" cy="17" r="2" stroke-width="2"/>
                                </svg>
                                <span class="text-xl font-bold">${v.targa}</span>
                            </div>
                            <p class="text-gray-600">${v.marca} ${v.modello} ${v.anno ? `(${v.anno})` : ''}</p>
                            ${v.chilometraggio ? `<p class="text-sm text-gray-500">${v.chilometraggio} km</p>` : ''}
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-sm font-semibold">
                                ${v.interventi.length}
                            </div>
                            <button onclick="deleteVehicle('${v.targa}')" class="text-red-500 hover:bg-red-50 px-2 py-1 rounded text-sm">
                                ‚úï
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function render() {
            const app = document.getElementById('app');

            if (!currentVehicle) {
                const vehiclesList = Object.values(vehicles);
                
                app.innerHTML = `
                    <div class="min-h-screen">
                        <div class="bg-blue-600 text-white p-4 shadow-lg">
                            <h1 class="text-2xl font-bold flex items-center gap-2">
                                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                Garage NFC
                            </h1>
                        </div>

                        <div class="p-4">
                            <div class="bg-white rounded-lg shadow p-4 mb-4">
                                <input
                                    type="text"
                                    id="searchInput"
                                    placeholder="üîç Cerca un veicolo..."
                                    class="w-full px-4 py-2 border rounded-lg"
                                    oninput="filterVehicles()"
                                />
                            </div>

                            <div class="bg-white rounded-lg shadow p-4 mb-4">
                                <h2 class="text-lg font-bold mb-3">‚ûï Nuovo Veicolo</h2>
                                <div class="space-y-2">
                                    <input type="text" id="newVehicleTarga" placeholder="Targa *" class="w-full px-3 py-2 border rounded text-lg font-bold uppercase">
                                    <div class="grid grid-cols-2 gap-2">
                                        <input type="text" id="newVehicleMarca" placeholder="Marca" class="px-3 py-2 border rounded">
                                        <input type="text" id="newVehicleModello" placeholder="Modello" class="px-3 py-2 border rounded">
                                    </div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <input type="number" id="newVehicleAnno" placeholder="Anno" class="px-3 py-2 border rounded">
                                        <input type="number" id="newVehicleKm" placeholder="Chilometraggio" class="px-3 py-2 border rounded">
                                    </div>
                                    <button onclick="addVehicle()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700">
                                        Aggiungi Veicolo
                                    </button>
                                </div>
                            </div>

                            <h2 class="text-xl font-bold mb-3">üöó Veicoli (${vehiclesList.length})</h2>
                            <div id="vehiclesList" class="space-y-3"></div>
                        </div>
                    </div>
                `;

                renderVehiclesList(vehiclesList);
                return;
            }

            const vehicle = vehicles[currentVehicle];

            if (!showAddForm) {
                app.innerHTML = `
                    <div class="min-h-screen">
                        <div class="bg-blue-600 text-white p-4 shadow-lg">
                            <button onclick="currentVehicle=null; render();" class="flex items-center gap-2 mb-2 hover:bg-blue-700 px-3 py-2 rounded">
                                ‚Üê Indietro
                            </button>
                            <div>
                                <h1 class="text-2xl font-bold">${vehicle.targa}</h1>
                                <p class="text-blue-100">${vehicle.marca} ${vehicle.modello} ${vehicle.anno ? `(${vehicle.anno})` : ''}</p>
                                ${vehicle.chilometraggio ? `<p class="text-sm text-blue-100">üìç ${vehicle.chilometraggio} km</p>` : ''}
                            </div>
                        </div>

                        <div class="p-4">
                            <button onclick="showAddForm=true; render();" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold mb-4 hover:bg-green-700 flex items-center justify-center gap-2">
                                <span class="text-xl">‚ûï</span> Nuovo Intervento
                            </button>

                            <div class="grid grid-cols-2 gap-3 mb-4">
                                <button onclick="exportToPDF()" class="bg-red-600 text-white py-2 rounded-lg font-semibold hover:bg-red-700 flex items-center justify-center gap-2">
                                    üìÑ Esporta TXT
                                </button>
                                <button onclick="exportToExcel()" class="bg-green-700 text-white py-2 rounded-lg font-semibold hover:bg-green-800 flex items-center justify-center gap-2">
                                    üìä Esporta CSV
                                </button>
                            </div>

                            <h2 class="text-xl font-bold mb-3">üìã Storico (${vehicle.interventi.length})</h2>

                            ${vehicle.interventi.length === 0 ? `
                                <div class="bg-white rounded-lg shadow p-8 text-center text-gray-500">
                                    <svg class="mx-auto mb-3 opacity-50" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" stroke-width="2"/>
                                    </svg>
                                    <p>Nessun intervento registrato</p>
                                </div>
                            ` : `
                                <div class="space-y-3">
                                    ${vehicle.interventi.map(inter => `
                                    <div class="bg-white rounded-lg shadow p-4">
                                        <div class="flex justify-between items-start mb-2">
                                            <div class="flex-1">
                                                <div class="text-sm text-gray-600 mb-1">
                                                    üìÖ ${inter.data || 'Data non specificata'}
                                                </div>
                                                <h3 class="font-bold text-lg text-blue-600">${inter.tipo}</h3>
                                            </div>
                                            <button onclick="deleteIntervento(${inter.id})" class="text-red-500 hover:bg-red-50 px-2 py-1 rounded text-sm font-bold">‚úï</button>
                                        </div>
                                        <p class="text-gray-700 mb-2">${inter.descrizione}</p>
                                        ${inter.ricambi ? `<div class="text-sm text-gray-600 mb-1"><span class="font-semibold">üîß Ricambi:</span> ${inter.ricambi}</div>` : ''}
                                        ${inter.note ? `
                                            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 mt-2 mb-2 rounded">
                                                <p class="text-sm text-gray-700"><span class="font-semibold">üí¨ Note:</span> ${inter.note}</p>
                                            </div>
                                        ` : ''}
                                        <div class="flex flex-wrap gap-3 mt-2 text-sm">
                                            ${inter.costo ? `<div class="text-green-600 font-semibold">üí∞ ${inter.costo} ‚Ç¨</div>` : ''}
                                            ${inter.chilometraggio ? `<div class="text-gray-600 font-semibold">üìç ${inter.chilometraggio} km</div>` : ''}
                                            ${inter.meccanico ? `<div class="text-gray-600">üë§ ${inter.meccanico}</div>` : ''}
                                        </div>
                                    </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                `;
            } else {
                const today = new Date().toISOString().split('T')[0];
                
                app.innerHTML = `
                    <div class="min-h-screen">
                        <div class="bg-blue-600 text-white p-4 shadow-lg">
                            <h1 class="text-xl font-bold">${vehicle.targa}</h1>
                            <p class="text-blue-100">‚ûï Nuovo Intervento</p>
                        </div>

                        <div class="p-4">
                            <div class="bg-white rounded-lg shadow p-4">
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm font-semibold mb-1">üìÖ Data *</label>
                                        <input type="date" id="interventoData" value="${today}" class="w-full px-3 py-2 border rounded">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold mb-1">üîß Tipo di lavoro *</label>
                                        <select id="interventoTipo" class="w-full px-3 py-2 border rounded text-base">
                                            <option value="">Seleziona...</option>
                                            <option value="Cambio olio">Cambio olio</option>
                                            <option value="Freni">Freni</option>
                                            <option value="Pneumatici">Pneumatici</option>
                                            <option value="Distribuzione">Distribuzione</option>
                                            <option value="Frizione">Frizione</option>
                                            <option value="Revisione">Revisione</option>
                                            <option value="Climatizzazione">Climatizzazione</option>
                                            <option value="Diagnostica">Diagnostica</option>
                                            <option value="Carrozzeria">Carrozzeria</option>
                                            <option value="Elettrico">Elettrico</option>
                                            <option value="Sospensioni">Sospensioni</option>
                                            <option value="Scarico">Scarico</option>
                                            <option value="Altro">Altro</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold mb-1">üìù Descrizione *</label>
                                        <textarea id="interventoDesc" rows="3" placeholder="Dettagli dell'intervento..." class="w-full px-3 py-2 border rounded"></textarea>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold mb-1">üî© Ricambi sostituiti</label>
                                        <input type="text" id="interventoRicambi" placeholder="Es: Pastiglie anteriori, dischi..." class="w-full px-3 py-2 border rounded">
                                    </div>

                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-sm font-semibold mb-1">üí∞ Costo (‚Ç¨)</label>
                                            <input type="number" id="interventoCosto" step="0.01" placeholder="0.00" class="w-full px-3 py-2 border rounded">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-semibold mb-1">üìç Chilometraggio</label>
                                            <input type="number" id="interventoKm" value="${vehicle.chilometraggio || ''}" placeholder="km" class="w-full px-3 py-2 border rounded">
                                        </div>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold mb-1">üë§ Meccanico</label>
                                        <input type="text" id="interventoMeccanico" placeholder="Nome del meccanico" class="w-full px-3 py-2 border rounded">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold mb-1">üí¨ Note / Osservazioni</label>
                                        <textarea id="interventoNote" rows="3" placeholder="Osservazioni, raccomandazioni, prossimi interventi..." class="w-full px-3 py-2 border rounded"></textarea>
                                    </div>

                                    <div class="flex gap-2 pt-2">
                                        <button onclick="addIntervento()" class="flex-1 bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700">
                                            ‚úÖ Salva
                                        </button>
                                        <button onclick="showAddForm=false; render();" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-400">
                                            ‚ùå Annulla
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        loadData();
        
        // Enregistrer le Service Worker pour PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(reg => console.log('‚úÖ Service Worker registrato'))
                    .catch(err => console.log('‚ùå Errore Service Worker:', err));
            });
        }
    </script>
</body>

</html>
