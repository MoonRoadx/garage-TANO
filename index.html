<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Sistema di tracciamento interventi meccanici con tecnologia NFC - Tano Evoluzione">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Tano Evoluzione">
    
    <title>Tano Evoluzione - Tracciamento Interventi</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* ---------- Fond d'√©cran principal ---------- */
        html, body {
            height: 100%;
            margin: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: url('Background.png') no-repeat center center fixed;
            background-size: cover;
            background-position: center center;
            color: white;
            min-height: 100vh;
            opacity: 0;
            animation: fadeIn 1s ease-in-out forwards;
        }
        body::before {
            content: "";
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, rgba(0,0,0,0.85) 0%, rgba(0,0,0,0.65) 50%, rgba(0,0,0,0.85) 100%);
            backdrop-filter: blur(2px);
            z-index: -1;
        }

        #app {
            background: rgba(0,0,0,0.45);
            min-height: 100vh;
            padding-bottom: 50px;
        }

        /* ---------- Effet verre d√©poli ---------- */
        .bg-white {
            background-color: rgba(30,30,35,0.88) !important;
            -webkit-backdrop-filter: blur(12px) saturate(120%);
            backdrop-filter: blur(12px) saturate(120%);
            border: 1px solid rgba(255,255,255,0.15);
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            transition: all 0.4s ease;
        }
        .bg-white:hover {
            box-shadow: 0 12px 40px rgba(0,0,0,0.6);
            transform: translateY(-2px);
            background-color: rgba(35,35,40,0.92) !important;
        }
        .bg-blue-600 {
            background: linear-gradient(135deg, rgba(29,78,216,0.95) 0%, rgba(21,58,162,0.95) 100%) !important;
            -webkit-backdrop-filter: blur(10px) saturate(120%);
            backdrop-filter: blur(10px) saturate(120%);
            border-bottom: 2px solid rgba(255,255,255,0.15);
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        .bg-green-600, .bg-green-700 {
            background: linear-gradient(135deg, rgba(22,163,74,0.95) 0%, rgba(21,128,61,0.95) 100%) !important;
            box-shadow: 0 6px 20px rgba(0,0,0,0.5);
        }
        .bg-red-600 {
            background: linear-gradient(135deg, rgba(220,38,38,0.95) 0%, rgba(185,28,28,0.95) 100%) !important;
            box-shadow: 0 6px 20px rgba(0,0,0,0.5);
        }

        /* ---------- Texte dans les cartes sombres ---------- */
        .bg-white p, .bg-white span, .bg-white h2, .bg-white h3 {
            color: #e5e7eb !important;
        }
        .text-gray-600, .text-gray-500, .text-gray-700 {
            color: #d1d5db !important;
        }
        .text-blue-600 {
            color: #60a5fa !important;
        }

        /* ---------- Inputs lisibles ---------- */
        input, textarea, select {
            color: #f3f4f6 !important;
            background-color: rgba(45,45,50,0.95) !important;
            border: 2px solid rgba(75,85,99,0.8) !important;
            font-weight: 500;
        }
        input::placeholder, textarea::placeholder {
            color: #9ca3af !important;
            font-weight: 400;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(59,130,246,0.3);
            border-color: #3b82f6 !important;
            background-color: rgba(55,55,60,0.98) !important;
        }

        /* ---------- Mobile / tablette ---------- */
        @media (max-width: 768px) {
            body {
                background-size: cover;
                background-position: center center;
            }
            body::before {
                background: linear-gradient(180deg, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.7) 30%, rgba(0,0,0,0.7) 70%, rgba(0,0,0,0.9) 100%);
                backdrop-filter: blur(3px);
            }
            #app {
                background: rgba(0,0,0,0.5);
            }
            .bg-white {
                background-color: rgba(25,25,30,0.92) !important;
                -webkit-backdrop-filter: blur(15px) saturate(130%);
                backdrop-filter: blur(15px) saturate(130%);
            }
        }

        /* ---------- Desktop ---------- */
        @media (min-width: 1024px) {
            body {
                background-size: 100% auto;
                background-position: center top;
            }
            body::before {
                background: linear-gradient(135deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.6) 50%, rgba(0,0,0,0.8) 100%);
            }
        }

        /* ---------- Animation fade-in ---------- */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Animation des cartes */
        .bg-white {
            animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>

<body class="bg-gray-100">
    <div id="app">Caricamento...</div>

    <script>
        // ========== SYST√àME MULTILINGUE ==========
        let currentLang = localStorage.getItem('app_language') || 'it';
        
        const translations = {
            it: {
                appName: "Tano Evoluzione",
                subtitle: "üîß Officina ‚Ä¢ Elettrauto ‚Ä¢ Aria Condizionata",
                loading: "Caricamento...",
                search: "üîç Cerca un veicolo...",
                newVehicle: "‚ûï Nuovo Veicolo",
                plate: "Targa",
                brand: "Marca",
                model: "Modello",
                year: "Anno",
                mileage: "Chilometraggio",
                addVehicle: "Aggiungi Veicolo",
                vehicles: "üöó Veicoli",
                noVehicles: "Nessun veicolo trovato",
                back: "‚Üê Indietro",
                newIntervention: "‚ûï Nuovo Intervento",
                exportTxt: "üìÑ Esporta TXT",
                exportCsv: "üìä Esporta CSV",
                history: "üìã Storico",
                noInterventions: "Nessun intervento registrato",
                date: "üìÖ Data",
                workType: "üîß Tipo di lavoro",
                selectType: "Seleziona...",
                description: "üìù Descrizione",
                descPlaceholder: "Dettagli dell'intervento...",
                parts: "üî© Ricambi sostituiti",
                partsPlaceholder: "Es: Pastiglie anteriori, dischi...",
                cost: "üí∞ Costo (‚Ç¨)",
                mechanic: "üë§ Meccanico",
                mechanicPlaceholder: "Nome del meccanico",
                notes: "üí¨ Note / Osservazioni",
                notesPlaceholder: "Osservazioni, raccomandazioni, prossimi interventi...",
                save: "‚úÖ Salva",
                cancel: "‚ùå Annulla",
                delete: "Eliminare",
                confirmDelete: "Eliminare questo intervento?",
                confirmDeleteVehicle: "Eliminare definitivamente il veicolo",
                vehicleNotExist: "Il veicolo",
                createNow: "non esiste ancora.\n\nVuoi crearlo ora?",
                plateRequired: "Targa obbligatoria",
                typeDescRequired: "Tipo e descrizione obbligatori",
                saveError: "Errore durante il salvataggio",
                noDate: "Data non specificata",
                // Types d'interventions
                types: {
                    oilChange: "Cambio Olio",
                    oilFilter: "Filtro Olio",
                    airFilter: "Filtro Aria",
                    fuelFilter: "Filtro Carburante",
                    cabinFilter: "Filtro Abitacolo",
                    sparkPlugs: "Candele",
                    timing: "Distribuzione",
                    brakes: "Freni",
                    tires: "Pneumatici",
                    clutch: "Frizione",
                    service: "Revisione",
                    ac: "Aria Condizionata",
                    diagnostic: "Diagnostica",
                    bodywork: "Carrozzeria",
                    electrical: "Elettrico/Elettrauto",
                    suspension: "Sospensioni",
                    exhaust: "Scarico",
                    other: "Altro"
                }
            },
            fr: {
                appName: "Tano Evoluzione",
                subtitle: "üîß Garage ‚Ä¢ √âlectricien Auto ‚Ä¢ Climatisation",
                loading: "Chargement...",
                search: "üîç Rechercher un v√©hicule...",
                newVehicle: "‚ûï Nouveau V√©hicule",
                plate: "Immatriculation",
                brand: "Marque",
                model: "Mod√®le",
                year: "Ann√©e",
                mileage: "Kilom√©trage",
                addVehicle: "Ajouter le V√©hicule",
                vehicles: "üöó V√©hicules",
                noVehicles: "Aucun v√©hicule trouv√©",
                back: "‚Üê Retour",
                newIntervention: "‚ûï Nouvelle Intervention",
                exportTxt: "üìÑ Export TXT",
                exportCsv: "üìä Export CSV",
                history: "üìã Historique",
                noInterventions: "Aucune intervention enregistr√©e",
                date: "üìÖ Date",
                workType: "üîß Type de travaux",
                selectType: "S√©lectionner...",
                description: "üìù Description",
                descPlaceholder: "D√©tails de l'intervention...",
                parts: "üî© Pi√®ces chang√©es",
                partsPlaceholder: "Ex: Plaquettes avant, disques...",
                cost: "üí∞ Co√ªt (‚Ç¨)",
                mechanic: "üë§ M√©canicien",
                mechanicPlaceholder: "Nom du m√©canicien",
                notes: "üí¨ Commentaires / Observations",
                notesPlaceholder: "Observations, recommandations, prochaines interventions...",
                save: "‚úÖ Enregistrer",
                cancel: "‚ùå Annuler",
                delete: "Supprimer",
                confirmDelete: "Supprimer cette intervention ?",
                confirmDeleteVehicle: "Supprimer d√©finitivement le v√©hicule",
                vehicleNotExist: "Le v√©hicule",
                createNow: "n'existe pas encore.\n\nVoulez-vous le cr√©er maintenant ?",
                plateRequired: "Immatriculation obligatoire",
                typeDescRequired: "Type et description obligatoires",
                saveError: "Erreur lors de la sauvegarde",
                noDate: "Date non sp√©cifi√©e",
                types: {
                    oilChange: "Vidange",
                    oilFilter: "Filtre √† Huile",
                    airFilter: "Filtre √† Air",
                    fuelFilter: "Filtre Carburant",
                    cabinFilter: "Filtre Habitacle",
                    sparkPlugs: "Bougies",
                    timing: "Distribution",
                    brakes: "Freins",
                    tires: "Pneus",
                    clutch: "Embrayage",
                    service: "R√©vision",
                    ac: "Climatisation",
                    diagnostic: "Diagnostic",
                    bodywork: "Carrosserie",
                    electrical: "√âlectrique/√âlectrauto",
                    suspension: "Suspension",
                    exhaust: "√âchappement",
                    other: "Autre"
                }
            },
            en: {
                appName: "Tano Evoluzione",
                subtitle: "üîß Workshop ‚Ä¢ Auto Electrician ‚Ä¢ Air Conditioning",
                loading: "Loading...",
                search: "üîç Search a vehicle...",
                newVehicle: "‚ûï New Vehicle",
                plate: "License Plate",
                brand: "Brand",
                model: "Model",
                year: "Year",
                mileage: "Mileage",
                addVehicle: "Add Vehicle",
                vehicles: "üöó Vehicles",
                noVehicles: "No vehicles found",
                back: "‚Üê Back",
                newIntervention: "‚ûï New Service",
                exportTxt: "üìÑ Export TXT",
                exportCsv: "üìä Export CSV",
                history: "üìã History",
                noInterventions: "No services recorded",
                date: "üìÖ Date",
                workType: "üîß Work Type",
                selectType: "Select...",
                description: "üìù Description",
                descPlaceholder: "Service details...",
                parts: "üî© Parts Replaced",
                partsPlaceholder: "Ex: Front brake pads, discs...",
                cost: "üí∞ Cost (‚Ç¨)",
                mechanic: "üë§ Mechanic",
                mechanicPlaceholder: "Mechanic name",
                notes: "üí¨ Notes / Observations",
                notesPlaceholder: "Observations, recommendations, upcoming services...",
                save: "‚úÖ Save",
                cancel: "‚ùå Cancel",
                delete: "Delete",
                confirmDelete: "Delete this service?",
                confirmDeleteVehicle: "Permanently delete vehicle",
                vehicleNotExist: "Vehicle",
                createNow: "does not exist yet.\n\nWould you like to create it now?",
                plateRequired: "License plate required",
                typeDescRequired: "Type and description required",
                saveError: "Error saving data",
                noDate: "Date not specified",
                types: {
                    oilChange: "Oil Change",
                    oilFilter: "Oil Filter",
                    airFilter: "Air Filter",
                    fuelFilter: "Fuel Filter",
                    cabinFilter: "Cabin Filter",
                    sparkPlugs: "Spark Plugs",
                    timing: "Timing Belt",
                    brakes: "Brakes",
                    tires: "Tires",
                    clutch: "Clutch",
                    service: "Service",
                    ac: "Air Conditioning",
                    diagnostic: "Diagnostic",
                    bodywork: "Bodywork",
                    electrical: "Electrical",
                    suspension: "Suspension",
                    exhaust: "Exhaust",
                    other: "Other"
                }
            }
        };
        
        function t(key) {
            const keys = key.split('.');
            let value = translations[currentLang];
            for (const k of keys) {
                value = value[k];
                if (!value) return key;
            }
            return value;
        }
        
        function changeLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('app_language', lang);
            render();
        }
        
        // ========== CODE PRINCIPAL ==========
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        let vehicles = {};
        let currentVehicle = null;
        let showAddForm = false;

        function loadData() {
            try {
                const stored = localStorage.getItem('garage_vehicles');
                if (stored) {
                    vehicles = JSON.parse(stored);
                }
            } catch (error) {
                console.log('Primo utilizzo');
                vehicles = {};
            }

            const targaFromUrl = getUrlParameter('targa');
            if (targaFromUrl) {
                const targaUpper = targaFromUrl.toUpperCase();
                
                if (vehicles[targaUpper]) {
                    currentVehicle = targaUpper;
                } else {
                    if (confirm(t('vehicleNotExist') + ` ${targaUpper} ` + t('createNow'))) {
                        setTimeout(() => {
                            const input = document.getElementById('newVehicleTarga');
                            if (input) {
                                input.value = targaUpper;
                                input.focus();
                            }
                        }, 100);
                    }
                }
            }

            render();
        }

        function saveData() {
            try {
                localStorage.setItem('garage_vehicles', JSON.stringify(vehicles));
            } catch (error) {
                console.error('Errore di salvataggio:', error);
                alert('Errore durante il salvataggio');
            }
        }

        function addVehicle() {
            const targa = document.getElementById('newVehicleTarga').value.toUpperCase().trim();
            const marca = document.getElementById('newVehicleMarca').value.trim();
            const modello = document.getElementById('newVehicleModello').value.trim();
            const anno = document.getElementById('newVehicleAnno').value.trim();
            const km = document.getElementById('newVehicleKm').value.trim();

            if (!targa) {
                alert(t('plateRequired'));
                return;
            }

            vehicles[targa] = {
                targa: targa,
                marca: marca,
                modello: modello,
                anno: anno,
                chilometraggio: km,
                interventi: []
            };

            saveData();
            currentVehicle = targa;
            render();
        }

        function addIntervento() {
            const data = document.getElementById('interventoData').value;
            const tipo = document.getElementById('interventoTipo').value;
            const descrizione = document.getElementById('interventoDesc').value;
            const ricambi = document.getElementById('interventoRicambi').value;
            const costo = document.getElementById('interventoCosto').value;
            const km = document.getElementById('interventoKm').value;
            const meccanico = document.getElementById('interventoMeccanico').value;
            const note = document.getElementById('interventoNote').value;

            if (!tipo || !descrizione) {
                alert(t('typeDescRequired'));
                return;
            }

            const intervento = {
                id: Date.now(),
                data: data,
                tipo: tipo,
                descrizione: descrizione,
                ricambi: ricambi,
                costo: costo,
                chilometraggio: km,
                meccanico: meccanico,
                note: note,
                dataRegistrazione: new Date().toISOString()
            };

            vehicles[currentVehicle].interventi.unshift(intervento);
            
            if (km) {
                vehicles[currentVehicle].chilometraggio = km;
            }

            saveData();
            showAddForm = false;
            render();
        }

        function deleteIntervento(id) {
            if (!confirm(t('confirmDelete'))) return;
            
            vehicles[currentVehicle].interventi = 
                vehicles[currentVehicle].interventi.filter(i => i.id !== id);
            
            saveData();
            render();
        }

        function deleteVehicle(targa) {
            if (!confirm(t('confirmDeleteVehicle') + ` ${targa}?`)) return;
            
            delete vehicles[targa];
            saveData();
            render();
        }

        function exportToExcel() {
            const vehicle = vehicles[currentVehicle];
            
            let testo = "Data;Tipo;Descrizione;Ricambi;Costo;Chilometraggio;Meccanico;Note\n";
            
            vehicle.interventi.forEach(inter => {
                testo += `${inter.data || ''};`;
                testo += `${inter.tipo || ''};`;
                testo += `${(inter.descrizione || '').replace(/;/g, ',')};`;
                testo += `${(inter.ricambi || '').replace(/;/g, ',')};`;
                testo += `${inter.costo || ''};`;
                testo += `${inter.chilometraggio || ''};`;
                testo += `${inter.meccanico || ''};`;
                testo += `${(inter.note || '').replace(/;/g, ',')}\n`;
            });

            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(testo));
            element.setAttribute('download', vehicle.targa + '.csv');
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }

        function exportToPDF() {
            const vehicle = vehicles[currentVehicle];
            
            let testo = `STORICO - ${vehicle.targa}\n`;
            testo += `${vehicle.marca} ${vehicle.modello} ${vehicle.anno || ''}\n`;
            if (vehicle.chilometraggio) testo += `Chilometraggio: ${vehicle.chilometraggio} km\n`;
            testo += `\n${'='.repeat(50)}\n\n`;
            
            vehicle.interventi.forEach((inter, i) => {
                testo += `${i + 1}. ${inter.data || 'Nessuna data'} - ${inter.tipo}\n`;
                testo += `   ${inter.descrizione}\n`;
                if (inter.ricambi) testo += `   Ricambi: ${inter.ricambi}\n`;
                if (inter.costo) testo += `   Costo: ${inter.costo} euro\n`;
                if (inter.chilometraggio) testo += `   Km: ${inter.chilometraggio}\n`;
                if (inter.meccanico) testo += `   Meccanico: ${inter.meccanico}\n`;
                if (inter.note) testo += `   Note: ${inter.note}\n`;
                testo += '\n';
            });
            
            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(testo));
            element.setAttribute('download', vehicle.targa + '.txt');
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }

        function filterVehicles() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const vehiclesList = Object.values(vehicles).filter(v =>
                v.targa.toLowerCase().includes(search) ||
                v.marca.toLowerCase().includes(search) ||
                v.modello.toLowerCase().includes(search)
            );
            
            renderVehiclesList(vehiclesList);
        }

        function renderVehiclesList(filteredVehicles) {
            const container = document.getElementById('vehiclesList');
            
            if (filteredVehicles.length === 0) {
                container.innerHTML = `
                    <div class="bg-white rounded-lg shadow p-8 text-center text-gray-500">
                        <svg class="mx-auto mb-3 opacity-50" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M5 17h14v-5.5L16.5 7H7.5L5 11.5V17z M5 17v1a1 1 0 001 1h1a1 1 0 001-1v-1M5 17h14m0 0v1a1 1 0 001 1h1a1 1 0 001-1v-1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <circle cx="8" cy="17" r="2" stroke-width="2"/>
                            <circle cx="16" cy="17" r="2" stroke-width="2"/>
                        </svg>
                        <p>${t('noVehicles')}</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredVehicles.map(v => `
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex-1 cursor-pointer" onclick="currentVehicle='${v.targa}'; render();">
                            <div class="flex items-center gap-2">
                                <svg width="24" height="24" class="text-blue-600" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path d="M5 17h14v-5.5L16.5 7H7.5L5 11.5V17z M5 17v1a1 1 0 001 1h1a1 1 0 001-1v-1M5 17h14m0 0v1a1 1 0 001 1h1a1 1 0 001-1v-1" stroke-width="2"/>
                                    <circle cx="8" cy="17" r="2" stroke-width="2"/>
                                    <circle cx="16" cy="17" r="2" stroke-width="2"/>
                                </svg>
                                <span class="text-xl font-bold">${v.targa}</span>
                            </div>
                            <p class="text-gray-600">${v.marca} ${v.modello} ${v.anno ? `(${v.anno})` : ''}</p>
                            ${v.chilometraggio ? `<p class="text-sm text-gray-500">${v.chilometraggio} km</p>` : ''}
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-sm font-semibold">
                                ${v.interventi.length}
                            </div>
                            <button onclick="deleteVehicle('${v.targa}')" class="text-red-500 hover:bg-red-50 px-2 py-1 rounded text-sm">
                                ‚úï
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function render() {
            const app = document.getElementById('app');

            if (!currentVehicle) {
                const vehiclesList = Object.values(vehicles);
                
                app.innerHTML = `
                    <div class="min-h-screen">
                        <div class="bg-blue-600 text-white p-4 shadow-lg">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-3">
                                    <img src="logo.png" alt="TANO Logo" class="h-12 w-12 object-contain rounded-lg bg-white p-1" onerror="this.style.display='none'">
                                    <div>
                                        <h1 class="text-2xl font-bold flex items-center gap-2">
                                            ${t('appName')}
                                        </h1>
                                        <p class="text-xs text-blue-100 mt-1">${t('subtitle')}</p>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="changeLanguage('it')" class="px-3 py-1 rounded ${currentLang === 'it' ? 'bg-white text-blue-600' : 'bg-blue-700'} font-semibold text-sm">üáÆüáπ</button>
                                    <button onclick="changeLanguage('fr')" class="px-3 py-1 rounded ${currentLang === 'fr' ? 'bg-white text-blue-600' : 'bg-blue-700'} font-semibold text-sm">üá´üá∑</button>
                                    <button onclick="changeLanguage('en')" class="px-3 py-1 rounded ${currentLang === 'en' ? 'bg-white text-blue-600' : 'bg-blue-700'} font-semibold text-sm">üá¨üáß</button>
                                </div>
                            </div>
                        </div>

                        <div class="p-4">
                            <div class="bg-white rounded-lg shadow p-4 mb-4">
                                <input
                                    type="text"
                                    id="searchInput"
                                    placeholder="${t('search')}"
                                    class="w-full px-4 py-2 border rounded-lg"
                                    oninput="filterVehicles()"
                                />
                            </div>

                            <div class="bg-white rounded-lg shadow p-4 mb-4">
                                <h2 class="text-lg font-bold mb-3">${t('newVehicle')}</h2>
                                <div class="space-y-2">
                                    <input type="text" id="newVehicleTarga" placeholder="${t('plate')} *" class="w-full px-3 py-2 border rounded text-lg font-bold uppercase">
                                    <div class="grid grid-cols-2 gap-2">
                                        <input type="text" id="newVehicleMarca" placeholder="${t('brand')}" class="px-3 py-2 border rounded">
                                        <input type="text" id="newVehicleModello" placeholder="${t('model')}" class="px-3 py-2 border rounded">
                                    </div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <input type="number" id="newVehicleAnno" placeholder="${t('year')}" class="px-3 py-2 border rounded">
                                        <input type="number" id="newVehicleKm" placeholder="${t('mileage')}" class="px-3 py-2 border rounded">
                                    </div>
                                    <button onclick="addVehicle()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700">
                                        ${t('addVehicle')}
                                    </button>
                                </div>
                            </div>

                            <h2 class="text-xl font-bold mb-3">${t('vehicles')} (${vehiclesList.length})</h2>
                            <div id="vehiclesList" class="space-y-3"></div>
                        </div>
                    </div>
                `;

                renderVehiclesList(vehiclesList);
                return;
            }

            const vehicle = vehicles[currentVehicle];

            if (!showAddForm) {
                app.innerHTML = `
                    <div class="min-h-screen">
                        <div class="bg-blue-600 text-white p-4 shadow-lg">
                            <button onclick="currentVehicle=null; render();" class="flex items-center gap-2 mb-2 hover:bg-blue-700 px-3 py-2 rounded">
                                ‚Üê ${t('back')}
                            </button>
                            <div class="flex items-center gap-3">
                                <img src="logo.png" alt="TANO Logo" class="h-10 w-10 object-contain rounded-lg bg-white p-1" onerror="this.style.display='none'">
                                <div>
                                    <h1 class="text-2xl font-bold">${vehicle.targa}</h1>
                                    <p class="text-blue-100">${vehicle.marca} ${vehicle.modello} ${vehicle.anno ? `(${vehicle.anno})` : ''}</p>
                                    ${vehicle.chilometraggio ? `<p class="text-sm text-blue-100">üìç ${vehicle.chilometraggio} km</p>` : ''}
                                </div>
                            </div>
                        </div>

                        <div class="p-4">
                            <button onclick="showAddForm=true; render();" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold mb-4 hover:bg-green-700 flex items-center justify-center gap-2">
                                <span class="text-xl">‚ûï</span> ${t('newIntervention')}
                            </button>

                            <div class="grid grid-cols-2 gap-3 mb-4">
                                <button onclick="exportToPDF()" class="bg-red-600 text-white py-2 rounded-lg font-semibold hover:bg-red-700 flex items-center justify-center gap-2">
                                    ${t('exportTxt')}
                                </button>
                                <button onclick="exportToExcel()" class="bg-green-700 text-white py-2 rounded-lg font-semibold hover:bg-green-800 flex items-center justify-center gap-2">
                                    ${t('exportCsv')}
                                </button>
                            </div>

                            <h2 class="text-xl font-bold mb-3">${t('history')} (${vehicle.interventi.length})</h2>

                            ${vehicle.interventi.length === 0 ? `
                                <div class="bg-white rounded-lg shadow p-8 text-center text-gray-500">
                                    <svg class="mx-auto mb-3 opacity-50" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" stroke-width="2"/>
                                    </svg>
                                    <p>${t('noInterventions')}</p>
                                </div>
                            ` : `
                                <div class="space-y-3">
                                    ${vehicle.interventi.map(inter => `
                                    <div class="bg-white rounded-lg shadow p-4">
                                        <div class="flex justify-between items-start mb-2">
                                            <div class="flex-1">
                                                <div class="text-sm text-gray-600 mb-1">
                                                    ${t('date')} ${inter.data || t('noDate')}
                                                </div>
                                                <h3 class="font-bold text-lg text-blue-600">${inter.tipo}</h3>
                                            </div>
                                            <button onclick="deleteIntervento(${inter.id})" class="text-red-500 hover:bg-red-50 px-2 py-1 rounded text-sm font-bold">‚úï</button>
                                        </div>
                                        <p class="text-gray-700 mb-2">${inter.descrizione}</p>
                                        ${inter.ricambi ? `<div class="text-sm text-gray-600 mb-1"><span class="font-semibold">${t('parts')}:</span> ${inter.ricambi}</div>` : ''}
                                        ${inter.note ? `
                                            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 mt-2 mb-2 rounded">
                                                <p class="text-sm text-gray-700"><span class="font-semibold">${t('notes')}:</span> ${inter.note}</p>
                                            </div>
                                        ` : ''}
                                        <div class="flex flex-wrap gap-3 mt-2 text-sm">
                                            ${inter.costo ? `<div class="text-green-600 font-semibold">${t('cost')} ${inter.costo} ‚Ç¨</div>` : ''}
                                            ${inter.chilometraggio ? `<div class="text-gray-600 font-semibold">üìç ${inter.chilometraggio} km</div>` : ''}
                                            ${inter.meccanico ? `<div class="text-gray-600">${t('mechanic')}: ${inter.meccanico}</div>` : ''}
                                        </div>
                                    </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                `;
            } else {
                const today = new Date().toISOString().split('T')[0];
                
                app.innerHTML = `
                    <div class="min-h-screen">
                        <div class="bg-blue-600 text-white p-4 shadow-lg">
                            <div class="flex items-center gap-3">
                                <img src="logo.png" alt="TANO Logo" class="h-10 w-10 object-contain rounded-lg bg-white p-1" onerror="this.style.display='none'">
                                <div>
                                    <h1 class="text-xl font-bold">${vehicle.targa}</h1>
                                    <p class="text-blue-100">${t('newIntervention')}</p>
                                </div>
                            </div>
                        </div>

                        <div class="p-4">
                            <div class="bg-white rounded-lg shadow p-4">
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm font-semibold mb-1">${t('date')} *</label>
                                        <input type="date" id="interventoData" value="${today}" class="w-full px-3 py-2 border rounded">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold mb-1">${t('workType')} *</label>
                                        <select id="interventoTipo" class="w-full px-3 py-2 border rounded text-base">
                                            <option value="">${t('selectType')}</option>
                                            <option value="${t('types.oilChange')}">${t('types.oilChange')}</option>
                                            <option value="${t('types.oilFilter')}">${t('types.oilFilter')}</option>
                                            <option value="${t('types.airFilter')}">${t('types.airFilter')}</option>
                                            <option value="${t('types.fuelFilter')}">${t('types.fuelFilter')}</option>
                                            <option value="${t('types.cabinFilter')}">${t('types.cabinFilter')}</option>
                                            <option value="${t('types.sparkPlugs')}">${t('types.sparkPlugs')}</option>
                                            <option value="${t('types.timing')}">${t('types.timing')}</option>
                                            <option value="${t('types.brakes')}">${t('types.brakes')}</option>
                                            <option value="${t('types.tires')}">${t('types.tires')}</option>
                                            <option value="${t('types.clutch')}">${t('types.clutch')}</option>
                                            <option value="${t('types.service')}">${t('types.service')}</option>
                                            <option value="${t('types.ac')}">${t('types.ac')}</option>
                                            <option value="${t('types.diagnostic')}">${t('types.diagnostic')}</option>
                                            <option value="${t('types.bodywork')}">${t('types.bodywork')}</option>
                                            <option value="${t('types.electrical')}">${t('types.electrical')}</option>
                                            <option value="${t('types.suspension')}">${t('types.suspension')}</option>
                                            <option value="${t('types.exhaust')}">${t('types.exhaust')}</option>
                                            <option value="${t('types.other')}">${t('types.other')}</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold mb-1">${t('description')} *</label>
                                        <textarea id="interventoDesc" rows="3" placeholder="${t('descPlaceholder')}" class="w-full px-3 py-2 border rounded"></textarea>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold mb-1">${t('parts')}</label>
                                        <input type="text" id="interventoRicambi" placeholder="${t('partsPlaceholder')}" class="w-full px-3 py-2 border rounded">
                                    </div>

                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-sm font-semibold mb-1">${t('cost')}</label>
                                            <input type="number" id="interventoCosto" step="0.01" placeholder="0.00" class="w-full px-3 py-2 border rounded">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-semibold mb-1">${t('mileage')}</label>
                                            <input type="number" id="interventoKm" value="${vehicle.chilometraggio || ''}" placeholder="km" class="w-full px-3 py-2 border rounded">
                                        </div>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold mb-1">${t('mechanic')}</label>
                                        <input type="text" id="interventoMeccanico" placeholder="${t('mechanicPlaceholder')}" class="w-full px-3 py-2 border rounded">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold mb-1">${t('notes')}</label>
                                        <textarea id="interventoNote" rows="3" placeholder="${t('notesPlaceholder')}" class="w-full px-3 py-2 border rounded"></textarea>
                                    </div>

                                    <div class="flex gap-2 pt-2">
                                        <button onclick="addIntervento()" class="flex-1 bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700">
                                            ${t('save')}
                                        </button>
                                        <button onclick="showAddForm=false; render();" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-400">
                                            ${t('cancel')}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        loadData();
        
        // Enregistrer le Service Worker pour PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(reg => console.log('‚úÖ Service Worker registrato'))
                    .catch(err => console.log('‚ùå Errore Service Worker:', err));
            });
        }
    </script>
</body>

</html>
